<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gmail Sorter - Fixed</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div id="loginScreen" class="screen">
        <div class="login-container">
            <div class="logo">üìß</div>
            <h1>Gmail Sorter</h1>
            <p class="subtitle">Casino ‚Ä¢ OTP ‚Ä¢ Social ‚Ä¢ Shopping ‚Ä¢ Auto-sorted</p>
            <button id="signInButton" class="google-signin-btn">Sign in with Google</button>
            <div id="errorMessage" style="color: red; margin-top: 20px; display: none;"></div>
        </div>
    </div>

    <div id="appScreen" class="screen hidden">
        <header class="app-header">
            <h1>Inbox</h1>
            <button id="signOutBtn" class="icon-btn">üö™</button>
            <div class="category-pills" id="categoryPills"></div>
        </header>
        <main class="email-list" id="emailList"></main>
    </div>

    <script>
        // Configuration
        const CONFIG = {
            GOOGLE_CLIENT_ID: '469028529540-399r7m34gkt3n05r7ss572jmkpbl5np8.apps.googleusercontent.com',
            GEMINI_API_KEY: 'AIzaSyAybN58q8KVEJ9yrlksgdPS5YX2K2vKNh0', 
            GMAIL_SCOPES: 'https://www.googleapis.com/auth/gmail.readonly',
            MAX_EMAILS: 50,
        };

        const EMAIL_CATEGORIES = {
            casino: { name: 'Casino', icon: 'üé∞', color: 'casino', keywords: ['casino','bet','poker','slots','blackjack','roulette','gambling','wager','bonus'] },
            otp: { name: 'OTP/2FA', icon: 'üîê', color: 'otp', keywords: ['code','verification','otp','2fa','verify','login code','security'] },
            social: { name: 'Social', icon: 'üë•', color: 'social', keywords: ['facebook','twitter','instagram','linkedin','social','friend','follow','comment'] },
            shopping: { name: 'Shopping', icon: 'üõçÔ∏è', color: 'shopping', keywords: ['order','amazon','ebay','shipping','delivery','purchase','payment','receipt'] },
            promotions: { name: 'Promo', icon: 'üì¢', color: 'promo', keywords: ['sale','discount','offer','deal','promo','coupon','save','limited time'] },
            finance: { name: 'Finance', icon: 'üí∞', color: 'finance', keywords: ['bank','transaction','statement','balance','payment','invoice','account'] },
            general: { name: 'General', icon: 'üìß', color: 'general', keywords: [] },
        };

        let accessToken = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('signInButton').addEventListener('click', signInWithGoogle);
            document.getElementById('signOutBtn').addEventListener('click', signOut);

            // Check for OAuth callback or stored token
            if (handleOAuth()) {
                loadEmails();
            } else if (localStorage.getItem('gmail_access_token')) {
                accessToken = localStorage.getItem('gmail_access_token');
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('appScreen').classList.remove('hidden');
                loadEmails();
            }
        });

        function signInWithGoogle() {
            const clientId = CONFIG.GOOGLE_CLIENT_ID;
            const redirectUri = window.location.origin + window.location.pathname;
            const scope = encodeURIComponent(CONFIG.GMAIL_SCOPES);
            window.location.href = `https://accounts.google.com/o/oauth2/v2/auth?client_id=${clientId}&redirect_uri=${encodeURIComponent(redirectUri)}&response_type=token&scope=${scope}&prompt=consent`;
        }

        function signOut() {
            localStorage.removeItem('gmail_access_token');
            window.location.reload();
        }

        function handleOAuth() {
            const hash = window.location.hash;
            if (hash && hash.includes('access_token')) {
                const params = new URLSearchParams(hash.substring(1));
                accessToken = params.get('access_token');
                localStorage.setItem('gmail_access_token', accessToken);
                window.history.replaceState(null, null, window.location.pathname);
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('appScreen').classList.remove('hidden');
                return true;
            }
            return false;
        }

        async function loadEmails() {
            try {
                const token = accessToken || localStorage.getItem('gmail_access_token');
                if (!token) throw new Error('No access token found');

                // Show loading
                document.getElementById('emailList').innerHTML = '<div style="text-align:center;padding:2rem;">Loading emails...</div>';

                // Fetch email list
                const listResponse = await fetch(
                    `https://gmail.googleapis.com/gmail/v1/users/me/messages?maxResults=${CONFIG.MAX_EMAILS}&q=in:inbox`,
                    { headers: { 'Authorization': `Bearer ${token}` } }
                );
                
                if (!listResponse.ok) {
                    throw new Error(`Gmail API error: ${listResponse.status} - ${listResponse.statusText}`);
                }
                
                const listData = await listResponse.json();
                
                if (!listData.messages || listData.messages.length === 0) {
                    document.getElementById('emailList').innerHTML = '<div style="text-align:center;padding:2rem;">No emails in inbox</div>';
                    return;
                }

                // Fetch full email details
                const emails = await Promise.all(listData.messages.map(msg => fetchEmail(msg.id, token)));

                // Categorize emails
                if (CONFIG.GEMINI_API_KEY && !CONFIG.GEMINI_API_KEY.includes('PASTE')) {
                    await categorizeWithGemini(emails);
                } else {
                    // Fallback to keyword matching
                    emails.forEach(email => {
                        const content = (email.subject + ' ' + email.from).toLowerCase();
                        for (const [id, cat] of Object.entries(EMAIL_CATEGORIES)) {
                            if (cat.keywords.some(k => content.includes(k))) {
                                email.category = id;
                                break;
                            }
                        }
                    });
                }

                renderEmails(emails);
                
            } catch (error) {
                console.error('Error loading emails:', error);
                document.getElementById('errorMessage').textContent = error.message;
                document.getElementById('errorMessage').style.display = 'block';
                document.getElementById('emailList').innerHTML = `<div style="text-align:center;padding:2rem;color:red;">Error: ${error.message}</div>`;
            }
        }

        async function fetchEmail(id, token) {
            try {
                const response = await fetch(
                    `https://gmail.googleapis.com/gmail/v1/users/me/messages/${id}?format=full`,
                    { headers: { 'Authorization': `Bearer ${token}` } }
                );
                
                if (!response.ok) {
                    throw new Error(`Failed to fetch email ${id}: ${response.status}`);
                }
                
                const msg = await response.json();
                
                // FIX: Check if msg.payload exists
                if (!msg.payload) {
                    console.warn('Email has no payload:', msg);
                    return {
                        id,
                        subject: 'No Subject',
                        from: 'Unknown',
                        date: new Date(),
                        snippet: 'Unable to load email',
                        category: 'uncategorized'
                    };
                }
                
                const headers = msg.payload.headers;
                
                return {
                    id,
                    subject: headers.find(h => h.name === 'Subject')?.value || 'No Subject',
                    from: headers.find(h => h.name === 'From')?.value || 'Unknown',
                    date: new Date(headers.find(h => h.name === 'Date')?.value || Date.now()),
                    snippet: msg.snippet || '',
                    category: 'uncategorized'
                };
            } catch (error) {
                console.error('Error fetching email:', error);
                return {
                    id,
                    subject: 'Error loading email',
                    from: 'Unknown',
                    date: new Date(),
                    snippet: error.message,
                    category: 'uncategorized'
                };
            }
        }

        async function categorizeWithGemini(emails) {
            const apiKey = CONFIG.GEMINI_API_KEY;
            
            for (let i = 0; i < emails.length; i++) {
                const email = emails[i];
                const categoryNames = Object.keys(EMAIL_CATEGORIES).join(', ');
                const prompt = `Categorize this email into ONE of these: ${categoryNames}. Just respond with the category name.\n\nEmail: "${email.subject}" from "${email.from}"`;
                
                const response = await fetch(
                    `https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${apiKey}`,
                    {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                    }
                );
                
                const data = await response.json();
                const category = data.candidates[0].content.parts[0].text.trim().toLowerCase();
                if (EMAIL_CATEGORIES[category]) email.category = category;
            }
        }

        function renderEmails(emails) {
            const pills = document.getElementById('categoryPills');
            const list = document.getElementById('emailList');
            
            // Count emails per category
            const counts = {};
            Object.keys(EMAIL_CATEGORIES).forEach(id => counts[id] = 0);
            emails.forEach(e => counts[e.category]++);
            
            // Render category pills
            let pillsHTML = `<button class="pill active" onclick="filterEmails('all')">All ${emails.length}</button>`;
            for (const [id, count] of Object.entries(counts)) {
                if (count > 0) {
                    const cat = EMAIL_CATEGORIES[id];
                    pillsHTML += `<button class="pill" onclick="filterEmails('${id}')">${cat.icon} ${cat.name} ${count}</button>`;
                }
            }
            pills.innerHTML = pillsHTML;
            
            // Render email list
            list.innerHTML = emails.map(e => {
                const cat = EMAIL_CATEGORIES[e.category];
                const sender = e.from.split('<')[0].trim();
                return `
                    <div class="email-item" onclick="window.open('https://mail.google.com/mail/u/0/#inbox/${e.id}', '_blank')">
                        <div class="category-badge badge-${cat.color}">${cat.icon} ${cat.name}</div>
                        <div class="email-sender">${sender}</div>
                        <div class="email-subject">${e.subject}</div>
                        <div class="email-snippet">${e.snippet}</div>
                    </div>
                `;
            }).join('');
        }

        function filterEmails(category) {
            alert('Filtering by ' + category + ' - refresh to see all');
        }
    </script>
</body>
</html>
